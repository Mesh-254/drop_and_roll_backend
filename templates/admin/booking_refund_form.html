{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}{{ title }}{% endblock %}

{% block content_title %}{{ title }}{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .refund-container { max-width: 800px; margin: 0 auto; }
        .refund-header { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 20px; border-radius: 8px 8px 0 0; margin-bottom: 20px; }
        .refund-header h1 { margin: 0; font-size: 1.5rem; font-weight: 600; }
        .details-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .details-card h2 { color: #374151; margin-top: 0; font-size: 1.2rem; border-bottom: 2px solid #3b82f6; padding-bottom: 8px; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 10px; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-weight: 500; color: #6b7280; }
        .detail-value { color: #111827; font-weight: 600; }
        .warning-alert { background: #fef3cd; border: 1px solid #f59e0b; color: #92400e; padding: 16px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #f59e0b; }
        .form-section { background: white; border: 1px solid #d1d5db; border-radius: 8px; padding: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #374151; margin-bottom: 4px; font-size: 0.95rem; }
        .form-group input[type="number"], .form-group input[type="text"] { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; transition: border-color 0.2s; }
        .form-group input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .help-text { font-size: 0.875rem; color: #6b7280; margin-top: 4px; }
        .button-group { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn { padding: 10px 20px; border-radius: 6px; font-weight: 500; text-decoration: none; display: inline-block; transition: background-color 0.2s; border: none; cursor: pointer; font-size: 0.95rem; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; }
        .status-success { background: #10b981; color: white; }
        .status-pending { background: #f59e0b; color: white; }
    </style>
{% endblock %}

{% block content %}
<div class="refund-container">
    <div class="refund-header">
        <h1>{{ title }}</h1>
        <p class="help-text" style="margin: 0; opacity: 0.9;">Process a secure refund for this booking. All actions are audited and notified via email.</p>
    </div>

    {% if warning %}
    <div class="warning-alert">
        <strong>‚ö†Ô∏è Important:</strong> {{ warning }}
    </div>
    {% endif %}

    <div class="details-card">
        <h2>üì¶ Booking Details</h2>
        <div class="detail-row">
            <span class="detail-label">Tracking Number:</span>
            <span class="detail-value">{{ booking.tracking_number|default:"Not assigned" }}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Customer:</span>
            <span class="detail-value">
                {% if booking.customer %}
                    {{ booking.customer.full_name }}
                {% else %}
                    {{ booking.guest_email }}
                {% endif %}
            </span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span class="detail-value">
                <span class="status-badge status-{{ booking.status|lower }}">{{ booking.get_status_display }}</span>
            </span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Final Price:</span>
            <span class="detail-value">{{ booking.final_price }} {{ transaction.currency|default:"KES" }}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Created:</span>
            <span class="detail-value">{{ booking.created_at|date:"M d, Y H:i" }}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Pickup Address:</span>
            <span class="detail-value">{{ booking.pickup_address|default:"Not specified" }}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Dropoff Address:</span>
            <span class="detail-value">{{ booking.dropoff_address|default:"Not specified" }}</span>
        </div>
    </div>

    <div class="details-card">
        <h2>üí≥ Payment Details</h2>
        <div class="detail-row">
            <span class="detail-label">Transaction ID:</span>
            <span class="detail-value">{{ transaction.id }}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Reference:</span>
            <span class="detail-value">{{ transaction.reference }}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Amount Paid:</span>
            <span class="detail-value">{{ transaction.amount }} {{ transaction.currency|default:"KES" }}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span class="detail-value">
                <span class="status-badge status-{{ transaction.status|lower }}">{{ transaction.get_status_display|default:transaction.status }}</span>
            </span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Paid At:</span>
            <span class="detail-value">{{ transaction.created_at|date:"M d, Y H:i" }}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Method:</span>
            <span class="detail-value">{{ transaction.method.method_type|default:"Unknown" }} ({{ transaction.method.provider|default:"N/A" }})</span>
        </div>
        {% if transaction.gateway_response %}
        <div class="detail-row">
            <span class="detail-label">Gateway Response:</span>
            <span class="detail-value">Processed successfully</span>
        </div>
        {% endif %}
    </div>

    <form method="post" class="form-section">
        {% csrf_token %}
        <h2 style="color: #374151; margin-bottom: 16px; font-size: 1.2rem;">Refund Details</h2>
        <div class="form-group">
            <label for="id_amount">Refund Amount ({{ transaction.currency|default:"KES" }}):</label>
            <input type="number" id="id_amount" name="amount" step="0.01" value="{{ default_amount }}" required min="0.01" max="{{ transaction.amount }}">
            <p class="help-text">Default/Full: {{ transaction.amount }} {{ transaction.currency|default:"KES" }} (Partial refunds allowed for flexibility)</p>
        </div>
        <div class="form-group">
            <label for="id_reason">Reason for Refund:</label>
            <input type="text" id="id_reason" name="reason" maxlength="255" required placeholder="e.g., Customer request, Damaged goods, Service issue">
            <p class="help-text">Required for audit and customer notification. Keep it concise and professional.</p>
        </div>
        <div class="button-group">
            <button type="button" onclick="window.location.href='{{ original_url }}'" class="btn btn-secondary">Cancel</button>
            <input type="submit" value="Refund" class="btn btn-primary">
        </div>
    </form>
</div>
{% endblock %}